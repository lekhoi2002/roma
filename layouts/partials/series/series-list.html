{{/* layouts/partials/series/series-list.html */}}
{{ $currentPage := . }}

{{ with $currentPage.Params.series }}
    {{ $seriesName := index . 0 }}
    {{ warnf "[Debug SeriesList] Checking for Series Name: '%s'" $seriesName }} {{/* DEBUG */}}

    {{/* --- THAY ĐỔI LOGIC TÌM KIẾM SERIES --- */}}
    {{ $seriesTerm := "" }}
    {{ $seriesPages := slice }}
    {{ with $.Site.Taxonomies.series }}
        {{ range $termKey, $termData := . }} {{/* Lặp qua tất cả các term trong taxonomy 'series' */}}
            {{ if eq $termData.Page.LinkTitle $seriesName }} {{/* So sánh tên hiển thị của term với tên series trong front matter */}}
                {{ $seriesTerm = $termData }} {{/* Lưu lại term đúng */}}
                {{ $seriesPages = $termData.Pages }} {{/* Lấy danh sách trang từ term đúng */}}
                {{ warnf "[Debug SeriesList] Found Matching Series Term: '%s'. Found %d pages." $termKey (len $seriesPages) }} {{/* DEBUG */}}
                {{ break }} {{/* Thoát vòng lặp khi tìm thấy */}}
            {{ end }}
        {{ end }}
        {{ if not $seriesTerm }}
            {{ warnf "[Debug SeriesList] FAILED to find matching Series Term in taxonomy for name: '%s'." $seriesName }} {{/* DEBUG */}}
        {{ end }}
    {{ else }}
        {{ warnf "[Debug SeriesList] FAILED: 'series' taxonomy not found." }} {{/* DEBUG */}}
    {{ end }}
    {{/* --- KẾT THÚC THAY ĐỔI LOGIC TÌM KIẾM --- */}}

    {{/* Sắp xếp các trang theo thứ tự series_order */}}
    {{ $sortedSeriesPages := sort $seriesPages "Params.series_order" "asc" }}

    {{ if gt (len $sortedSeriesPages) 1 }} {{/* Chỉ hiển thị nếu có nhiều hơn 1 bài */}}
        <div class="card series-card shadow-sm">
            <div class="card-header bg-primary-subtle">
                <h5 class="card-title mb-0 fs-6 fw-semibold">
                    <i class="fas fa-stream me-2"></i>
                    Phần của series: {{ $seriesName }}
                </h5>
            </div>
            <ul class="list-group list-group-flush">
                {{ range $index, $page := $sortedSeriesPages }}
                    {{ $isCurrent := eq $page.Permalink $currentPage.Permalink }}
                    {{ $seriesOrder := $page.Params.series_order | default (add $index 1) }}
                    <li class="list-group-item p-0">
                        <a href="{{ $page.RelPermalink }}"
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {{ if $isCurrent }}active{{ end }}"
                           {{ if $isCurrent }}aria-current="true"{{ end }}>
                            <span>
                                <span class="series-order fw-bold me-2">Phần {{ $seriesOrder }}:</span>
                                {{ $page.Title }}
                            </span>
                            {{ if $isCurrent }}
                                <i class="fas fa-check ms-2"></i>
                            {{ else }}
                                <i class="fas fa-chevron-right fa-xs text-muted ms-2"></i>
                            {{ end }}
                        </a>
                    </li>
                {{ end }}
            </ul>
        </div>
    {{ else }}
         {{ if eq (len $sortedSeriesPages) 1 }}
             {{ warnf "[Debug SeriesList] Series '%s' only has 1 page. Not displaying list." $seriesName }}
         {{ end }}
    {{ end }}
{{ end }}