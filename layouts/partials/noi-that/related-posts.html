{{/*
    Partials/noi-that/related-posts.html
    Hiển thị các bài viết liên quan trong cùng thư mục (section).
    Ưu tiên hiển thị các bài có 'weight' trong front matter (số nhỏ trước).
    Các bài không có 'weight' sẽ hiển thị sau, sắp xếp theo ngày mới nhất.
  */}}

{{ $limit := 3 }} {{/* Giới hạn số bài viết liên quan cần hiển thị */}}
{{ $currentPagePermalink := .Permalink }}
{{ $relatedPosts := slice }} {{/* Slice cuối cùng để hiển thị */}}

{{/*
  1. Tìm tất cả các trang thông thường trong cùng section, loại trừ trang hiện tại
*/}}
{{ $pagesInSameSection := where .Site.RegularPages "Section" .Section }}
{{ $potentialRelatedAll := where $pagesInSameSection ".Permalink" "!=" $currentPagePermalink }}

{{/*
  2. Tách thành 2 nhóm: có weight và không có weight
*/}}
{{ $weightedPages := slice }}
{{ $unweightedPages := slice }}

{{ range $page := $potentialRelatedAll }}
  {{ if isset $page.Params "weight" }}
    {{ $weight := $page.Params.weight }}
    {{ $validWeight := false }}

    {{/* Kiểm tra weight có phải số không bằng cách an toàn */}}
    {{ if or (eq (printf "%T" $weight) "int") (eq (printf "%T" $weight) "float64") }}
      {{ $validWeight = true }}
    {{ else if eq (printf "%T" $weight) "string" }}
      {{ $weightNum := 0 }}
      {{ if eq $weight "0" }}{{ $validWeight = true }}{{ else }}{{ $weightNum = int $weight | default 0 }}{{ if ne (printf "%v" $weightNum) "0" }}{{ $validWeight = true }}{{ end }}{{ end }}
    {{ end }}

    {{ if $validWeight }}
      {{ $weightedPages = $weightedPages | append $page }}
    {{ else }}
      {{/* Ghi log cảnh báo nếu weight không hợp lệ (tùy chọn) */}}
      {{/* warnf "Related Posts: Page '%s' has a non-numeric weight value '%v'. Treating as unweighted." $page.File.Path $weight */}}
      {{ $unweightedPages = $unweightedPages | append $page }}
    {{ end }}
  {{ else }}
    {{ $unweightedPages = $unweightedPages | append $page }}
  {{ end }}
{{ end }}

{{/*
  3. Sắp xếp từng nhóm
*/}}
{{ $sortedWeighted := sort $weightedPages ".Params.weight" }}
{{ $sortedUnweighted := sort $unweightedPages ".Date" "desc" }}

{{/*
  4. Kết hợp 2 danh sách đã sắp xếp
*/}}
{{ $combinedSorted := $sortedWeighted | append $sortedUnweighted }}

{{/*
  5. Lấy $limit bài đầu tiên
*/}}
{{ $relatedPosts = first $limit $combinedSorted }}


{{/* --- PHẦN HIỂN THỊ CÁC BÀI LIÊN QUAN --- */}}

{{ if $relatedPosts }}
<div class="related-posts-section mt-5 pt-4 border-top">
  <h3 class="mb-4 text-center">Sản phẩm liên quan</h3>
  <div class="row row-cols-1 row-cols-md-3 g-4">
    {{ range $relatedPosts }}
      <div class="col">
        <div class="card h-100 shadow-sm related-post-card">
          {{ $permalink := .RelPermalink }}
          {{ $title := .Title }}
          {{ $thumbnail := .Params.thumbnail }} {{/* Lấy đường dẫn từ front matter */}}

          {{/* Xử lý Thumbnail */}}
          {{ $imageUrl := "" }} {{/* Khởi tạo biến URL ảnh cuối cùng */}}
          {{ if $thumbnail }}
            {{ $src := $thumbnail }}
            {{ if not (urls.Parse $src).Scheme }} {{/* Chỉ xử lý ảnh cục bộ (không phải http/https) */}}
              {{ $original := resources.Get $src }} {{/* Cố gắng tìm ảnh trong 'assets' */}}
              {{ if $original }}
                {{ $processedImage := $original.Fill "400x300" }} {{/* Resize ảnh thành 400x300 */}}
                {{ $imageUrl = $processedImage.RelPermalink }} {{/* Lấy đường dẫn của ảnh đã xử lý */}}
              {{ else }}
                {{ $imageUrl = $src }} {{/* Nếu không tìm thấy, dùng URL gốc */}}
                {{ warnf "Related Posts Thumbnail: Resource not found for '%s' in page '%s'. Using original path." $src .File.Path }} {{/* Giữ lại cảnh báo này nếu muốn */}}
              {{ end }}
            {{ else }}
              {{ $imageUrl = $src }} {{/* Nếu là link ngoài, dùng URL gốc */}}
            {{ end }}
          {{ end }}

          {{/* Link bao quanh ảnh */}}
          <a href="{{ $permalink }}" title="{{ $title }}">
            {{ if ne $imageUrl "" }} {{/* Hiển thị ảnh nếu có URL */}}
              <img src="{{ $imageUrl }}" {{/* Sử dụng URL đã được xác định */}}
                   class="card-img-top"
                   alt="{{ with .Params.image_alt }}{{ . }}{{ else }}{{ printf "%s - Ảnh liên quan" $title }}{{ end }}"
                   loading="lazy">
            {{ else }}
              {{/* Fallback hiển thị nếu không có ảnh */}}
              <div class="card-img-top bg-light d-flex align-items-center justify-content-center text-muted" style="height: 225px; font-size: 0.9rem;">
                 <span>Ảnh đại diện</span>
              </div>
            {{ end }}
          </a>

          {{/* Phần Tiêu đề */}}
          <div class="card-body text-center">
            <h5 class="card-title related-title mb-0">
              <a href="{{ $permalink }}" class="text-decoration-none stretched-link">{{ $title }}</a>
            </h5>
          </div>
        </div>
      </div>
    {{ end }}
  </div>
</div>
{{ end }}